/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package net.praqma.prqa.reports;

import java.util.List;
import net.praqma.jenkins.plugin.prqa.PrqaException;
import net.praqma.prqa.PRQAComplianceStatus;
import net.praqma.prqa.PRQATask;
import net.praqma.prqa.parsers.ComplianceReportHtmlParser;
import net.praqma.prqa.parsers.ReportHtmlParser;
import net.praqma.prqa.products.QAR;

/**
 *
 * @author Praqma
 */
public class PRQAComplianceReport<T extends PRQAComplianceStatus, K extends String> implements PRQATask<T,K> {
   private ReportHtmlParser parser;
   private QAR qar;

   public PRQAComplianceReport(QAR qar) {
       this.qar = qar;
       this.parser = new ComplianceReportHtmlParser();
   }
   
   public PRQAComplianceReport() {
       this.parser = new ComplianceReportHtmlParser();
   }
   
   public PRQAComplianceReport(ReportHtmlParser parser) {
       this.parser = parser;
   }
    /**
     * @return the parser
     */
    public ReportHtmlParser getParser() {
        return parser;
    }
    
    /**
     * @param parser the parser to set
     */
    public void setParser(ReportHtmlParser parser) {
        this.parser = parser;
    }
    
    /**
     * Completes the job of creating usable data given a path to a report generated by QAR. This is the Compliance report
     * @param reportpath
     * @return 
     */
    public T completeTask(K reportpath) {
        //Generate the report
        qar.execute();
        
        //Parse it.
        PRQAComplianceStatus stat = new PRQAComplianceStatus();
        
        try {
            List<String> parseResult = parser.parse((K)reportpath, ComplianceReportHtmlParser.totalMessagesPattern);
            if(!parseResult.isEmpty()) {
                Integer tmp = Integer.parseInt(parseResult.get(0)); 
                stat.setMessages(tmp);
            }
            
            parseResult = parser.parse((K)reportpath, ComplianceReportHtmlParser.fileCompliancePattern);
            if(!parseResult.isEmpty()) {
                Double tmp = Double.parseDouble(parseResult.get(0));
                stat.setFileCompliance(tmp);
            }
            parseResult = parser.parse((K)reportpath, ComplianceReportHtmlParser.projectCompliancePattern);
            if(!parseResult.isEmpty()) {
                Double tmp = Double.parseDouble(parseResult.get(0));
                stat.setProjectCompliance(tmp);
            }
            
        } catch (PrqaException ex) {
            
        }
        return (T)stat;
    }
}
